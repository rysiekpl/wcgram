<!DOCTYPE html>
<html>
<head>
  <title>WC Gram</title>
  <script src="js/jquery-2.0.3.min.js"></script>
  <script src="js/ol.js"></script>
  <script src="js/toilet_data.js"></script>
  <link rel="stylesheet" href="css/ol.css" type="text/css">
  <link rel="stylesheet" href="css/style.css" type="text/css">
  <script>
  
    var map = false;
    var vectorLayer = false
    var iconFeatures = [];
    
    $(function() {
      

      var vectorSource = new ol.source.Vector({
        features: []
      });

      var iconStyle = new ol.style.Style({
        image: new ol.style.Icon(/** @type {olx.style.IconOptions} */ ({
          anchor: [0.5, 0.5],
          anchorXUnits: 'fraction',
          anchorYUnits: 'fraction',
          scale: 0.3,
          opacity: 0.75,
          src: 'img/toilet-by-victor-fedyuk-the-noun-project-cc-by-3.0.svg'
        }))
      });

      vectorLayer = new ol.layer.Vector({
        source: vectorSource,
        style: iconStyle
      });
      
      //
      // Create map
      //
    
      map = new ol.Map({
        controls: ol.control.defaults({
          attributionOptions: /** @type {olx.control.AttributionOptions} */ ({
            collapsible: false
          })
        }),
        target: 'map',
        layers: [
          new ol.layer.Tile({
            source: new ol.source.MapQuest({
              layer:"osm"
            })
          }),
          vectorLayer
        ],
        view: new ol.View({
          center: ol.proj.transform([21.43, 42.00], 'EPSG:4326', 'EPSG:3857'),
          zoom: 13,
          maxZoom: 17
        })
      });
      
      // display popup on click
      map.on('click', function(evt) {
        var feature = map.forEachFeatureAtPixel(evt.pixel,
            function(feature, layer) {
              return feature;
            });
        if (feature) {
          // go to info.html
          document.location.href = 'info.html?id=' + feature.get('id')
        }
      });

      // change mouse cursor when over marker
      map.on('pointermove', function(e) {
        var pixel = map.getEventPixel(e.originalEvent);
        var hit = map.hasFeatureAtPixel(pixel);
        this.getTargetElement().style.cursor = hit ? 'pointer' : '';
      });
      
      /**
        * get the data
        */
      $.each(toiletData, function( key, val) {
        vectorSource.addFeature(new ol.Feature({
          geometry: new ol.geom.Point(ol.proj.transform([val.lng, val.lat], 'EPSG:4326',     
          'EPSG:3857')),
          name: val.name,
          rating: val.rating,
          soap: val.soap,
          toilet: val.toilet,
          link: val.link,
          address: val.address,
          id: key
        }));
      });
      
    });
    
  </script>
</head>
<body class="index">
  <div id="map" class="map"></div>
</body>
</html>